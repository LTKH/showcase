//function loadPage(url) {
//    console.log(url);
//    history.pushState('', 'Showcase', url);
//}

var menu = {};

(function($) {

    $.fn.treeControl = function(x) {
        if (x.action === "create") {
            this.empty();

            var menu_arr = [];

            function get_template(url){
                //$.each(templates, function(undefined, v) {
                for (i = 0; i < templates.length; i++) {
                    var re = new RegExp(templates[i]['url']);
                    if (re.test(url)) {
                        //menu[url]['template'] = v['tmpl'];
                        return templates[i]['tmpl'];
                    }
                }
                //});
                return '';
            }

            function get_nodes(nodes) {
                var sub = [];
                if (nodes.length > 0) {
                    $.each(nodes, function(undefined, n) {
                        menu[n.path] = {};
                        menu[n.path]['name'] = n.name;
                        menu[n.path]['options'] = n.options;
                        menu[n.path]['template'] = get_template(n.path);
                        sub.push('<li class="has-sub">');
                        sub.push('<a href="' + n.path + '" onclick="loadPage(\'' + n.path + '\'); return false;"><b ');
                        if (n.nodes) { sub.push('class="caret"'); }
                        sub.push('></b>' + n.name + '<span></span></a>');
                        sub.push('<ul class="sub-menu closed">');
                        if (n.nodes) {
                            sub.push(get_nodes(n.nodes));
                        }
                        sub.push('</ul>');
                        sub.push('</li>');
                    });
                }
                return sub.join('\n');
            }

            menu_arr.push('<ul class="nav">');
            menu_arr.push('<li class="nav-header">Navigation</li>');
            $.each(x.data, function(undefined, n) {
                menu[n.path] = {};
                menu[n.path]['name'] = n.name;
                menu[n.path]['options'] = n.options;
                menu[n.path]['template'] = get_template(n.path);
                get_template(n.path);
                n.class = n.class || 'fa fa-th-large';
                menu_arr.push('<li class="has-sub">');
                menu_arr.push('<a href="' + n.path + '" onclick="loadPage(\'' + n.path + '\'); return false;">');
                menu_arr.push('<b class="caret"></b><i class="' + n.class + '"></i><span>' + n.name + '</span></a>');
                menu_arr.push('<ul class="sub-menu closed">');
                if (n.nodes) { menu_arr.push(get_nodes(n.nodes)); }
                menu_arr.push('</ul>');
                menu_arr.push('</li>');
            });
            menu_arr.push('<li><a href="javascript:;" class="sidebar-minify-btn" data-click="sidebar-minify"><i class="fa fa-angle-double-left"></i></a></li>');
            menu_arr.push('</ul>');
            return this.html(menu_arr.join('\n'));
        }

    };

})(jQuery);